<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生成結果 - 板書ログ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">
</head>

<body>
    <header>
        <h1 class="header-title">板書ログ</h1>
    </header>
    <nav class="nav-container">
        <ul class="nav-list">
            <li class="nav-item"><a href="/">ホーム</a></li>
            <li class="nav-item"><a href="/archive">アーカイブ</a></li>
        </ul>
    </nav>

    <main>
        <h1 class="section-title"><span class="marker-red">生成完了！</span></h1>

        <div class="app-card">
            <h2 class="section-title" style="font-size:1.4rem; text-align:left;"><span
                    class="marker-yellow">板書の読み取り結果</span></h2>
            <pre class="ai-result-pre" style="max-height: 150px; overflow-y: auto;">{{ extracted_text_data }}</pre>
        </div>

        <div class="app-card">
            <h2 class="section-title" style="font-size:1.4rem; text-align:left;"><span
                    class="marker-yellow">AI要約ノート</span></h2>
            <div class="ai-result-pre">{{ summary_text | safe }}</div>
        </div>

        <div class="app-card" style="border-color: var(--primary-color);">
            <h2 class="section-title"><span class="marker-red">復習問題に挑戦</span></h2>

            <div id="quiz-container" class="quiz-container">
                {% for quiz in quizzes %}
                <div class="quiz-item" data-quiz-type="{{ quiz.type }}">
                    <p style="font-weight:bold; margin-bottom:10px;">Q. {{ quiz.question }}</p>

                    {% if quiz.type == '穴埋め' %}
                    <input type="text" class="user-answer" placeholder="回答を入力">
                    <input type="hidden" class="correct-answer" value="{{ quiz.answer }}">
                    {% elif quiz.type == '選択' %}
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        {% for choice in quiz.choices %}
                        <label style="cursor:pointer;">
                            <input type="radio" name="choice-{{ loop.index0 }}-{{ loop.parent.loop.index0 }}"
                                value="{{ choice }}" class="user-answer">
                            {{ choice }}
                        </label>
                        {% endfor %}
                    </div>
                    <input type="hidden" class="correct-answer" value="{{ quiz.answer }}">
                    {% elif quiz.type == '記述' %}
                    <textarea class="user-answer" rows="3" placeholder="回答を入力"></textarea>
                    <input type="hidden" class="correct-answer" value="{{ quiz.answer }}">
                    {% endif %}

                    <div class="feedback" style="margin-top:10px; font-weight:bold;"></div>
                </div>
                {% endfor %}
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button onclick="checkAnswers()" class="action-button">答え合わせをする</button>
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <a href="/" class="action-button action-button-secondary">別のノートを作る</a>
        </div>
    </main>

    <footer>
        <p>© 2025 BanshoLog</p>
    </footer>

    <script>
        async function checkAnswers() {
            const quizItems = document.querySelectorAll('.quiz-item');

            for (const item of quizItems) {
                const quizType = item.dataset.quizType;
                const correctAnswer = item.querySelector('.correct-answer').value;
                const feedbackSpan = item.querySelector('.feedback');
                let userAnswer, isCorrect;

                // リセット
                feedbackSpan.textContent = '';
                feedbackSpan.style.color = 'inherit';

                if (quizType === '穴埋め' || quizType === '記述') {
                    const input = item.querySelector('.user-answer');
                    userAnswer = input.value.trim();

                    if (quizType === '記述') {
                        // 記述はサーバーサイドチェック（省略時は簡易一致）
                        // ※ 元のコードの非同期fetch部分を維持してください
                        // ここではUIの動作確認用に簡易版にします
                        isCorrect = (userAnswer === correctAnswer);
                        // 本当はここに fetch('/check_descriptive'...)
                    } else {
                        isCorrect = (userAnswer === correctAnswer.trim());
                    }

                    if (isCorrect) {
                        input.style.borderColor = 'green';
                        input.style.backgroundColor = '#e6fffa';
                        feedbackSpan.textContent = '正解！';
                        feedbackSpan.style.color = 'green';
                    } else {
                        input.style.borderColor = 'red';
                        input.style.backgroundColor = '#fff5f5';
                        feedbackSpan.textContent = `不正解 (正解: ${correctAnswer})`;
                        feedbackSpan.style.color = 'red';
                    }

                } else if (quizType === '選択') {
                    const selected = item.querySelector('.user-answer:checked');
                    userAnswer = selected ? selected.value : '';
                    isCorrect = (userAnswer.trim() === correctAnswer.trim());

                    if (isCorrect) {
                        feedbackSpan.textContent = '正解！';
                        feedbackSpan.style.color = 'green';
                    } else {
                        feedbackSpan.textContent = `不正解 (正解: ${correctAnswer})`;
                        feedbackSpan.style.color = 'red';
                    }
                }
            }
        }
    </script>
</body>

</html>